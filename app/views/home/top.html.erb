<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>親密度LV.1</title>
  <!-- スタイルシートのリンクやその他のメタタグをここに挿入 -->
</head>
<body>
  <header>
  <%= render 'shared/header' %>
  </header>

  <main>
    <div id="progress-bar">
      <!-- 進捗バーの実装 -->
    </div>
    
    <!-- ここから吹き出しの表示 -->
    <div class="character-speech">
    <%= image_tag("speech.png", alt: "speech bubble", class: "speech-bubble") %>
    <div class="speech-text" id="speech-text">
      <% if @speech_text %>
        <span id="time-to-sober" data-hours="<%= @hours %>" data-minutes="<%= @minutes %>">
          <%= @speech_text %>
        </span>
      <% else %>
        <%= @random_speech.alcohol_speeches %>
      <% end %>
    </div>
  </div>

    <!-- ここまで吹き出しの表示 -->

    <div class="panda-image">
      <% if @character %>
      <div class="selected-character" id="character-image" data-character-id="<%= @character.id %>">
          <%= image_tag(@character.animal.downcase + '.png', alt: @character.animal, class: "character-img") %>
          <p><%= @character.animal %></p>
        </div>
      <% end %>
    </div>

    <div class="actions">
      <%= link_to '飲むよ！', choose_drink_path, class: 'button' %>
      <%= link_to "共有！", "https://twitter.com/intent/tweet?text=お好きなテキスト", target: "_blank", class: "button" %>
    </div>
  </main>

  <footer>
  <%= render 'shared/footer' %>
  </footer>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    // 既存の機能: アルコールが抜けるまでの時間を更新
    const timeToSober = document.getElementById('time-to-sober');
    if (timeToSober) {
      let hours = parseInt(timeToSober.dataset.hours, 10);
      let minutes = parseInt(timeToSober.dataset.minutes, 10);

      const updateTimer = () => {
        if (minutes > 0 || hours > 0) {
          if (minutes === 0 && hours > 0) {
            hours -= 1;
            minutes = 59;
          } else {
            minutes -= 1;
          }
          timeToSober.textContent = `あと${hours}時間${minutes}分でアルコールが抜けるよ！`;
          timeToSober.dataset.hours = hours.toString();
          timeToSober.dataset.minutes = minutes.toString();
        }
      };

      setInterval(updateTimer, 60000);
    }

    // 新しい機能: キャラクター画像をクリックしたときにランダムなセリフを表示
    const characterImage = document.getElementById('character-image');
    const speechText = document.getElementById('speech-text');
    if (characterImage && speechText) {
      characterImage.addEventListener('click', () => {
        const characterId = characterImage.getAttribute('data-character-id');
        fetch(`/api/characters/${characterId}/random_speech`)
          .then(response => response.json())
          .then(data => {
            speechText.textContent = data.speech;
          })
          .catch(error => console.error('ランダムセリフの取得エラー:', error));
      });
    }
  });
  </script>
</body>
</html>